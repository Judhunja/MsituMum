<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - MsituMum</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700;900&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200" rel="stylesheet">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        "primary": "#13ec13",
                        "green-dark": "#1a3a1a",
                        "green-medium": "#4c854c",
                    },
                    fontFamily: {
                        "display": ["Inter", "sans-serif"]
                    }
                }
            }
        }
    </script>
    <style>
        body { font-family: 'Inter', sans-serif; }
        .primary-color { color: #13ec13; }
        .bg-primary { background-color: #166534; }
    </style>
</head>
<body class="font-display bg-gray-50">
    <div class="relative flex min-h-screen w-full">
        <!-- Sidebar -->
        <aside class="sticky top-0 h-screen w-64 flex-shrink-0 bg-green-800 p-4 flex flex-col justify-between">
            <div class="flex flex-col gap-6">
                <div class="flex items-center gap-3">
                    <div class="bg-center bg-no-repeat aspect-square bg-cover rounded-full size-10" style='background-image: url("https://cdn-icons-png.flaticon.com/512/628/628283.png");'></div>
                    <div class="flex flex-col">
                        <h1 class="text-white text-base font-medium">MsituMum</h1>
                        <p class="text-green-200 text-sm">Restoration System</p>
                    </div>
                </div>
                <nav class="flex flex-col gap-2">
                    <a class="flex items-center gap-3 px-3 py-2 rounded-lg bg-green-700 text-white" href="/dashboard.html">
                        <span class="material-symbols-outlined">dashboard</span>
                        <p class="text-sm font-bold">Dashboard</p>
                    </a>
                    <a class="flex items-center gap-3 px-3 py-2 rounded-lg hover:bg-white/10 text-white" href="/index.html">
                        <span class="material-symbols-outlined">analytics</span>
                        <p class="text-sm font-medium">Analytics</p>
                    </a>
                    <a class="flex items-center gap-3 px-3 py-2 rounded-lg hover:bg-white/10 text-white" href="/sites.html">
                        <span class="material-symbols-outlined">map</span>
                        <p class="text-sm font-medium">Sites</p>
                    </a>
                    <a class="flex items-center gap-3 px-3 py-2 rounded-lg hover:bg-white/10 text-white" href="/nursery.html">
                        <span class="material-symbols-outlined">local_florist</span>
                        <p class="text-sm font-medium">Nurseries</p>
                    </a>
                    <a class="flex items-center gap-3 px-3 py-2 rounded-lg hover:bg-white/10 text-white" href="/prediction.html">
                        <span class="material-symbols-outlined">insights</span>
                        <p class="text-sm font-medium">Predictions</p>
                    </a>
                    <a class="flex items-center gap-3 px-3 py-2 rounded-lg hover:bg-white/10 text-white" href="/biodiversity.html">
                        <span class="material-symbols-outlined">eco</span>
                        <p class="text-sm font-medium">Biodiversity</p>
                    </a>
                    <a class="flex items-center gap-3 px-3 py-2 rounded-lg hover:bg-white/10 text-white" href="/forms.html">
                        <span class="material-symbols-outlined">description</span>
                        <p class="text-sm font-medium">Data Entry</p>
                    </a>
                </nav>
            </div>
            <div class="flex flex-col gap-1">
                <a class="flex items-center gap-3 px-3 py-2 rounded-lg hover:bg-white/10 text-white" href="/settings.html">
                    <span class="material-symbols-outlined">settings</span>
                    <p class="text-sm font-medium">Settings</p>
                </a>
                <a class="flex items-center gap-3 px-3 py-2 rounded-lg hover:bg-white/10 text-white" href="#" id="logoutBtn">
                    <span class="material-symbols-outlined">logout</span>
                    <p class="text-sm font-medium">Logout</p>
                </a>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="flex-1 p-8 overflow-y-auto">
            <div class="max-w-7xl mx-auto">
                <!-- Welcome Section -->
                <div class="mb-8">
                    <h2 class="text-3xl font-bold text-gray-900 mb-2">Welcome, <span id="userName"></span>!</h2>
                    <p class="text-gray-600">Here's an overview of your forest restoration activities</p>
                </div>

                <!-- Stats Grid -->
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                    <div class="bg-white p-6 rounded-lg shadow">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-sm text-gray-600">Total Trees Planted</p>
                                <p id="totalTrees" class="text-3xl font-bold text-green-700">-</p>
                            </div>
                            <span class="material-symbols-outlined text-4xl text-green-600">park</span>
                        </div>
                    </div>

                    <div class="bg-white p-6 rounded-lg shadow">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-sm text-gray-600">Planting Sites</p>
                                <p id="totalSites" class="text-3xl font-bold text-green-700">-</p>
                            </div>
                            <span class="material-symbols-outlined text-4xl text-green-600">location_on</span>
                        </div>
                    </div>

                    <div class="bg-white p-6 rounded-lg shadow">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-sm text-gray-600">Average Survival Rate</p>
                                <p id="survivalRate" class="text-3xl font-bold text-green-700">-</p>
                            </div>
                            <span class="material-symbols-outlined text-4xl text-green-600">eco</span>
                        </div>
                    </div>

                    <div class="bg-white p-6 rounded-lg shadow">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-sm text-gray-600">Total Investment</p>
                                <p id="totalCost" class="text-3xl font-bold text-green-700">-</p>
                            </div>
                            <span class="material-symbols-outlined text-4xl text-green-600">payments</span>
                        </div>
                    </div>
                </div>

                <!-- Quick Actions -->
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                    <a href="/forms/nursery-form.html" class="bg-white p-6 rounded-lg shadow hover:shadow-lg transition">
                        <div class="flex items-center gap-4">
                            <span class="material-symbols-outlined text-5xl text-green-600">add_circle</span>
                            <div>
                                <h3 class="text-xl font-bold text-gray-900">Add Nursery</h3>
                                <p class="text-sm text-gray-600">Register a new tree nursery</p>
                            </div>
                        </div>
                    </a>

                    <a href="/nursery.html" class="bg-white p-6 rounded-lg shadow hover:shadow-lg transition">
                        <div class="flex items-center gap-4">
                            <span class="material-symbols-outlined text-5xl text-green-600">nature</span>
                            <div>
                                <h3 class="text-xl font-bold text-gray-900">Manage Nurseries</h3>
                                <p class="text-sm text-gray-600">View and update nurseries</p>
                            </div>
                        </div>
                    </a>

                    <a href="/prediction.html" class="bg-white p-6 rounded-lg shadow hover:shadow-lg transition">
                        <div class="flex items-center gap-4">
                            <span class="material-symbols-outlined text-5xl text-green-600">analytics</span>
                            <div>
                                <h3 class="text-xl font-bold text-gray-900">Run Simulation</h3>
                                <p class="text-sm text-gray-600">Predict survival rates</p>
                            </div>
                        </div>
                    </a>
                </div>

                <!-- Recent Activity -->
                <div class="bg-white rounded-lg shadow">
                    <div class="p-6 border-b">
                        <h3 class="text-xl font-bold text-gray-900">Recent Planting Records</h3>
                    </div>
                    <div class="p-6">
                        <table class="w-full">
                            <thead>
                                <tr class="text-left text-sm text-gray-600">
                                    <th class="pb-3">Site Name</th>
                                    <th class="pb-3">Species</th>
                                    <th class="pb-3">Trees Planted</th>
                                    <th class="pb-3">Date</th>
                                    <th class="pb-3">Latest Survival</th>
                                </tr>
                            </thead>
                            <tbody id="recentPlantings" class="text-sm">
                                <tr>
                                    <td colspan="5" class="py-4 text-center text-gray-500">Loading...</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script>
        // Get user info
        const token = localStorage.getItem('token');
        const user = JSON.parse(localStorage.getItem('user') || '{}');

        document.getElementById('userName').textContent = user.full_name || user.username || 'User';

        // Logout
        document.getElementById('logoutBtn').addEventListener('click', () => {
            auth.logout();
        });

        // Fetch dashboard data
        async function loadDashboard() {
            try {
                // Get planting records
                const plantingRes = await fetch('/api/planting', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const plantingData = await plantingRes.json();

                // Get sites
                const sitesRes = await fetch('/api/sites', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const sitesData = await sitesRes.json();

                // Get monitoring records
                const monitoringRes = await fetch('/api/monitoring', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const monitoringData = await monitoringRes.json();

                // Calculate stats
                const totalTrees = plantingData.reduce((sum, p) => sum + (p.seedlings_planted || 0), 0);
                document.getElementById('totalTrees').textContent = totalTrees.toLocaleString();
                document.getElementById('totalSites').textContent = sitesData.length;

                // Calculate average survival rate
                if (monitoringData.length > 0) {
                    const avgSurvival = monitoringData.reduce((sum, m) => sum + (m.survival_count || 0), 0) / monitoringData.length;
                    document.getElementById('survivalRate').textContent = Math.round(avgSurvival);
                } else {
                    document.getElementById('survivalRate').textContent = 'N/A';
                }

                // Get costs
                try {
                    const costsRes = await fetch('/api/analytics/costs', {
                        headers: { 'Authorization': `Bearer ${token}` }
                    });
                    const costsData = await costsRes.json();
                    const totalCost = costsData.reduce((sum, c) => sum + (c.amount || 0), 0);
                    document.getElementById('totalCost').textContent = 'KSh ' + totalCost.toLocaleString();
                } catch(e) {
                    document.getElementById('totalCost').textContent = 'KSh 0';
                }

                // Display recent plantings
                const recentTable = document.getElementById('recentPlantings');
                if (plantingData.length > 0) {
                    recentTable.innerHTML = plantingData.slice(0, 10).map(p => {
                        const monitoring = monitoringData.find(m => m.planting_id === p.id);
                        return `
                            <tr class="border-t">
                                <td class="py-3">${p.site_name || 'Unknown Site'}</td>
                                <td class="py-3">${p.species_name || 'N/A'}</td>
                                <td class="py-3">${p.seedlings_planted?.toLocaleString() || 0}</td>
                                <td class="py-3">${new Date(p.planting_date).toLocaleDateString()}</td>
                                <td class="py-3">${monitoring ? monitoring.survival_count + ' trees' : 'No data'}</td>
                            </tr>
                        `;
                    }).join('');
                } else {
                    recentTable.innerHTML = '<tr><td colspan="5" class="py-4 text-center text-gray-500">No planting records yet</td></tr>';
                }

            } catch (error) {
                console.error('Error loading dashboard:', error);
            }
        }

        loadDashboard();
    </script>
    <script src="/js/auth.js"></script>
    <script>
        // Check authentication after auth.js loads
        if (!auth.isAuthenticated()) {
            window.location.href = '/login.html';
        }
    </script>
</body>
</html>
